<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boligkostkalkulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0 auto;
            padding: 10px;
            max-width: 100%;
        }
        h1 {
            font-size: 1.5rem;
            text-align: center;
        }
        .form-container {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 15px 0;
            width: 100%;
        }
        button:hover {
            background-color: #45a049;
        }
        .chart-container {
            width: 100%;
            overflow-x: auto;
        }
        .bar {
            fill: steelblue;
        }
        .bar:hover {
            fill: #7db9e8;
        }
        .axis-label {
            font-size: 12px;
            font-weight: bold;
        }
        .threshold-line {
            stroke: red;
            stroke-dasharray: 5,5;
            stroke-width: 2;
        }
        .bar-value {
            font-size: 10px;
            text-anchor: middle;
        }
        
        /* Media Queries */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            h1 {
                font-size: 2rem;
            }
            .form-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            button {
                width: auto;
                padding: 10px 15px;
            }
            .axis-label {
                font-size: 14px;
            }
            .bar-value {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <h1>Boligkostkalkulator</h1>
    
    <div class="form-container">
        <div>
            <div class="form-group">
                <label for="address">Adresse:</label>
                <input type="text" id="address" value="Øysteins gate 4">
            </div>
            <div class="form-group">
                <label for="price">Pris (kr):</label>
                <input type="number" id="price" value="2990000">
            </div>
        </div>
        <div>
            <div class="form-group">
                <label for="communal">Kommunale avgifter per år (kr):</label>
                <input type="number" id="communal" value="7242">
            </div>
            <div class="form-group">
                <label for="shared">Felleskostnader per måned (kr):</label>
                <input type="number" id="shared" value="2000">
            </div>
            <div class="form-group">
                <label for="propertyTax">Eiendomsskatt per år (kr):</label>
                <input type="number" id="propertyTax" value="2437">
            </div>
            <div class="form-group">
                <label for="interestRate">Årlig rente (%):</label>
                <input type="number" id="interestRate" value="5.5" step="0.1">
            </div>
        </div>
    </div>
    
    <button id="calculate">Generer graf</button>
    
    <div class="chart-container">
        <div id="chart"></div>
    </div>
    
    <script>
        document.getElementById('calculate').addEventListener('click', generateGraph);
        
        // Initial graph on page load
        window.addEventListener('load', function() {
            generateGraph();
        });
        
        // Redraw on window resize
        window.addEventListener('resize', debounce(function() {
            generateGraph();
        }, 250));
        
        // Debounce function to limit how often a function is called
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        function calculateMonthlyCost(price, communalFee, sharedCost, propertyTax, interestRate) {
            // Fixed values
            const equity = 1500000; // Removed from UI, fixed at 1.5M
            const threshold = 14000; // Removed from UI, fixed at 14K
            
            const loan = price - equity;
            const monthlyInterestRate = interestRate / 100 / 12;
            const n = 30 * 12; // 360 months (30 years)
            
            const monthlyPayment = loan * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, n) / 
                                 (Math.pow(1 + monthlyInterestRate, n) - 1);
            
            const monthlyCommunalFee = communalFee / 12;
            const monthlyPropertyTax = propertyTax / 12;
            
            return {
                total: monthlyPayment + monthlyCommunalFee + sharedCost + monthlyPropertyTax,
                threshold: threshold
            };
        }
        
        function formatNumber(num) {
            // Format with spaces as thousand separators and kr suffix
            return new Intl.NumberFormat('no-NO', { 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(num)) + " kr";
        }
        
        function formatNumberAxis(num) {
            // Format with spaces as thousand separators, no kr suffix, for axis
            return new Intl.NumberFormat('no-NO', { 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(num));
        }
        
        function generateGraph() {
            // Get input values
            const address = document.getElementById('address').value;
            const price = Number(document.getElementById('price').value);
            const communalFee = Number(document.getElementById('communal').value);
            const sharedCost = Number(document.getElementById('shared').value);
            const propertyTax = Number(document.getElementById('propertyTax').value);
            const interestRate = Number(document.getElementById('interestRate').value);
            
            // Generate price range
            const priceRange = [];
            const costRange = [];
            let threshold = 0;
            
            for (let p = price - 200000; p <= price + 900000; p += 100000) {
                priceRange.push(p);
                const costData = calculateMonthlyCost(p, communalFee, sharedCost, propertyTax, interestRate);
                costRange.push(costData.total);
                threshold = costData.threshold;
            }
            
            // Clear previous chart
            d3.select("#chart").html("");
            
            // Set dimensions and margins - responsive
            const chartContainer = document.querySelector('.chart-container');
            const containerWidth = chartContainer.clientWidth;
            const isMobile = window.innerWidth < 768;
            
            const margin = isMobile 
                ? {top: 40, right: 20, bottom: 90, left: 70} 
                : {top: 50, right: 30, bottom: 90, left: 100};
                
            const width = Math.max(containerWidth - margin.left - margin.right, 300);
            const height = isMobile ? 350 : 500 - margin.top - margin.bottom;
            
            // Create SVG
            const svg = d3.select("#chart")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .style("display", "block")
                    .style("margin", "0 auto")
                .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // X axis
            const x = d3.scaleBand()
                .range([0, width])
                .domain(priceRange.map(d => d))
                .padding(0.2);
            
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d => {
                    // On mobile, show fewer ticks
                    if (isMobile && priceRange.indexOf(d) % 2 !== 0) {
                        return "";
                    }
                    return formatNumberAxis(d);
                }))
                .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)")
                    .style("font-size", isMobile ? "8px" : "10px");
            
            // Add X axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - (isMobile ? 15 : 10))
                .text("Kjøpepris (kr)")
                .style("font-size", isMobile ? "10px" : "14px");
            
            // Y axis
            const maxCost = Math.max(...costRange) + 2000;
            const y = d3.scaleLinear()
                .domain([0, maxCost])
                .range([height, 0]);
            
            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => formatNumberAxis(d)))
                .selectAll("text")
                .style("font-size", isMobile ? "8px" : "10px");
            
            // Add Y axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + (isMobile ? 20 : 30))
                .text("Totale kostnader per måned (kr)")
                .style("font-size", isMobile ? "10px" : "14px");
            
            // Add title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", isMobile ? "14px" : "18px")
                .style("font-weight", "bold")
                .text(address);
            
            // Add threshold line
            svg.append("line")
                .attr("class", "threshold-line")
                .attr("x1", 0)
                .attr("x2", width)
                .attr("y1", y(threshold))
                .attr("y2", y(threshold));
                
            // Add threshold label
            svg.append("text")
                .attr("x", width - 5)
                .attr("y", y(threshold) - 5)
                .attr("text-anchor", "end")
                .style("fill", "red")
                .style("font-size", isMobile ? "8px" : "12px")
                .text(formatNumber(threshold));
            
            // Add bars
            svg.selectAll(".bar")
                .data(costRange)
                .enter()
                .append("rect")
                    .attr("class", "bar")
                    .attr("x", (d, i) => x(priceRange[i]))
                    .attr("y", d => y(d))
                    .attr("width", x.bandwidth())
                    .attr("height", d => height - y(d));
            
            // Add value labels on top of bars (only if not mobile or if mobile with fewer labels)
            svg.selectAll(".bar-value")
                .data(costRange)
                .enter()
                .append("text")
                    .attr("class", "bar-value")
                    .attr("x", (d, i) => x(priceRange[i]) + x.bandwidth() / 2)
                    .attr("y", d => y(d) - 5)
                    .style("visibility", function(d, i) {
                        // On mobile, show fewer values
                        if (isMobile && i % 2 !== 0) {
                            return "hidden";
                        }
                        return "visible";
                    })
                    .style("font-size", isMobile ? "8px" : "10px")
                    .text(d => formatNumber(d));
        }
    </script>
</body>
</html>